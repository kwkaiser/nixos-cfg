version: "3"

vars:
  host: "vm"
  arch: "linux"
  disks: 3

tasks:
  homelab-vm:
    cmds:
      - nix run .#nixosConfigurations.homelab.config.system.build.vmWithDisko > /dev/null 2>&1 &
      - |
        while true; do
          ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -p 2222 kwkaiser@localhost echo 'connected' && break
          echo "Connection refused, retrying in 5 seconds..."
          sleep 5
        done
      - sleep 5
      - ssh -o StrictHostKeyChecking=no -p 2222 kwkaiser@localhost sudo cat /etc/rancher/k3s/k3s.yaml > ~/.kube/config
      - kitty +kitten ssh -o StrictHostKeyChecking=no -p 2222 kwkaiser@localhost

  clean:
    cmds:
      - rm -rf data
      - rm -rf result
      - rm -rf result-*
      - rm -rf keys
      - rm -rf *.fd
      - rm -rf *.qcow2
